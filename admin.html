<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - KM Ã‰ducateur Canin</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      color: #ecf0f1;
    }

    .admin-login {
      max-width: 400px;
      margin: 100px auto;
      padding: 40px;
      background: linear-gradient(135deg, #34495e, #2c3e50);
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.4);
      text-align: center;
      border: 2px solid #f1c40f;
    }

    .admin-panel {
      display: none;
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: linear-gradient(145deg, #34495e, #2c3e50);
      padding: 25px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      border: 1px solid #f1c40f;
    }

    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      color: #f1c40f;
      margin: 10px 0;
    }

    .reservations-list {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      margin-bottom: 30px;
      border: 1px solid #f1c40f;
    }

    .reservation-item {
      border-bottom: 1px solid #4a6572;
      padding: 20px 0;
      color: #ecf0f1;
      position: relative;
    }

    .reservation-item:last-child {
      border-bottom: none;
    }

    .reservation-item strong {
      color: #f1c40f;
    }

    .delete-btn {
      position: absolute;
      top: 20px;
      right: 10px;
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.3s ease;
    }

    .delete-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 3px 10px rgba(231, 76, 60, 0.4);
    }

    .export-btn {
      background: linear-gradient(45deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      margin-left: 10px;
    }

    .export-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
    }

    .admin-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .logout-btn {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
    }

    .empty-message {
      text-align: center;
      color: #bdc3c7;
      font-style: italic;
      padding: 40px;
    }

    .reservation-info {
      margin-right: 100px; /* Espace pour le bouton supprimer */
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="logo-container">
        <img src="img/logo.jpeg alt="Logo KM" class="logo-img">
        <span class="logo-text">KM Ã©ducateur canin - Admin</span>
      </div>
    </nav>
  </header>

  <div class="admin-container">
    <!-- Formulaire de connexion -->
    <div id="adminLogin" class="admin-login">
      <h2>Connexion Admin</h2>
      <form id="loginForm">
        <input type="password" id="adminPassword" placeholder="Mot de passe administrateur" required>
        <button type="submit" class="btn-submit" style="width: 100%; margin-top: 20px;">Se connecter</button>
      </form>
    </div>

    <!-- Panneau d'administration -->
    <div id="adminPanel" class="admin-panel">
      <div class="admin-actions">
        <button class="logout-btn" onclick="logout()">DÃ©connexion</button>
        <div>
          <button class="export-btn" onclick="exportToPDF('reservations')">ğŸ“Š Export RÃ©servations PDF</button>
          <button class="export-btn" onclick="exportToPDF('contacts')">ğŸ“Š Export Contacts PDF</button>
          <button class="export-btn" onclick="exportToPDF('all')">ğŸ“Š Export Complet PDF</button>
        </div>
      </div>
      
      <h1>Panneau d'Administration</h1>
      
      <div class="admin-stats">
        <div class="stat-card">
          <h3>RÃ©servations Total</h3>
          <div class="stat-number" id="totalReservations">0</div>
        </div>
        
        <div class="stat-card">
          <h3>Contacts Ce Mois</h3>
          <div class="stat-number" id="monthlyContacts">0</div>
        </div>
        
        <div class="stat-card">
          <h3>Demandes Visio</h3>
          <div class="stat-number" id="visioRequests">0</div>
        </div>
        
        <div class="stat-card">
          <h3>Ã€ Rappeler</h3>
          <div class="stat-number" id="callBacks">0</div>
        </div>
      </div>

      <div class="reservations-list">
        <h2>DerniÃ¨res RÃ©servations</h2>
        <div id="reservationsList">
          <!-- Les rÃ©servations seront affichÃ©es ici -->
        </div>
      </div>

      <div class="reservations-list" style="margin-top: 40px;">
        <h2>Demandes de Contact</h2>
        <div id="contactsList">
          <!-- Les contacts seront affichÃ©es ici -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialiser jsPDF
    const { jsPDF } = window.jspdf;

    document.addEventListener("DOMContentLoaded", () => {
      const loginForm = document.getElementById('loginForm');
      const adminLogin = document.getElementById('adminLogin');
      const adminPanel = document.getElementById('adminPanel');

      // VÃ©rifier si dÃ©jÃ  connectÃ©
      if (localStorage.getItem('adminLoggedIn') === 'true') {
        showAdminPanel();
      }

      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const password = document.getElementById('adminPassword').value;
        
        // Mot de passe simple (Ã  changer en production)
        if (password === 'KMadmin2025') {
          localStorage.setItem('adminLoggedIn', 'true');
          showAdminPanel();
        } else {
          alert('Mot de passe incorrect');
        }
      });

      function showAdminPanel() {
        adminLogin.style.display = 'none';
        adminPanel.style.display = 'block';
        loadAdminData();
      }

      function loadAdminData() {
        // Charger les rÃ©servations et contacts
        const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
        const contacts = JSON.parse(localStorage.getItem("contacts") || "[]");
        
        // Calculer les statistiques
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        
        const monthlyContacts = contacts.filter(contact => {
          const contactDate = new Date(contact.date);
          return contactDate.getMonth() === currentMonth && contactDate.getFullYear() === currentYear;
        }).length;
        
        const visioRequests = reservations.filter(r => r.visio === 'oui').length +
                             contacts.filter(c => c.service === 'visio').length;
        
        const callBacks = reservations.filter(r => r.rappel === 'oui').length +
                         contacts.filter(c => c.rappel === 'oui').length;

        // Mettre Ã  jour les statistiques
        document.getElementById('totalReservations').textContent = reservations.length;
        document.getElementById('monthlyContacts').textContent = monthlyContacts;
        document.getElementById('visioRequests').textContent = visioRequests;
        document.getElementById('callBacks').textContent = callBacks;

        // Afficher les rÃ©servations
        const reservationsList = document.getElementById('reservationsList');
        if (reservations.length === 0) {
          reservationsList.innerHTML = '<div class="empty-message">Aucune rÃ©servation pour le moment.</div>';
        } else {
          reservationsList.innerHTML = reservations.slice(-20).reverse().map((reservation, index) => `
            <div class="reservation-item">
              <div class="reservation-info">
                <strong>${reservation.prenom} ${reservation.nom}</strong><br>
                ğŸ“ ${reservation.telephone} | ğŸ“§ ${reservation.email}<br>
                ğŸ• ${reservation.chien}<br>
                ğŸ“ ${reservation.adresse}<br>
                ğŸ—“ï¸ ${reservation.date}<br>
                ${reservation.visio === 'oui' ? 'ğŸ’» Visio demandÃ©e' : ''}
                ${reservation.rappel === 'oui' ? 'ğŸ“ Rappel demandÃ©' : ''}
              </div>
              <button class="delete-btn" onclick="deleteReservation(${reservations.length - 1 - index})">ğŸ—‘ï¸ Supprimer</button>
            </div>
          `).join('');
        }

        // Afficher les contacts
        const contactsList = document.getElementById('contactsList');
        if (contacts.length === 0) {
          contactsList.innerHTML = '<div class="empty-message">Aucune demande de contact pour le moment.</div>';
        } else {
          contactsList.innerHTML = contacts.slice(-20).reverse().map((contact, index) => `
            <div class="reservation-item">
              <div class="reservation-info">
                <strong>${contact.prenom} ${contact.nom}</strong><br>
                ğŸ“ ${contact.telephone} | ğŸ“§ ${contact.email}<br>
                ğŸ• ${contact.chien}<br>
                ğŸ¯ ${getServiceName(contact.service)}<br>
                âš ï¸ ${getUrgencyName(contact.urgence)}<br>
                ğŸ—“ï¸ ${contact.date}<br>
                ${contact.rappel === 'oui' ? 'ğŸ“ Rappel demandÃ©' : 'ğŸ“§ Email uniquement'}
              </div>
              <button class="delete-btn" onclick="deleteContact(${contacts.length - 1 - index})">ğŸ—‘ï¸ Supprimer</button>
            </div>
          `).join('');
        }
      }

      // Fonctions utilitaires pour l'admin
      window.getServiceName = function(service) {
        const services = {
          'education': 'Ã‰ducation de Base',
          'comportement': 'ProblÃ¨mes Comportementaux',
          'socialisation': 'Socialisation',
          'visio': 'Consultation Visio',
          'balade': 'Balades Ã‰ducatives',
          'chiot': 'Ã‰ducation Chiot'
        };
        return services[service] || service;
      }

      window.getUrgencyName = function(urgency) {
        const urgencies = {
          'faible': 'Peu urgent',
          'moyen': 'Urgence moyenne',
          'elevee': 'Urgence Ã©levÃ©e'
        };
        return urgencies[urgency] || urgency;
      }

      // Fonction de suppression d'une rÃ©servation
      window.deleteReservation = function(index) {
        if (confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cette rÃ©servation ?')) {
          const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
          reservations.splice(index, 1);
          localStorage.setItem("reservations", JSON.stringify(reservations));
          loadAdminData();
        }
      }

      // Fonction de suppression d'un contact
      window.deleteContact = function(index) {
        if (confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cette demande de contact ?')) {
          const contacts = JSON.parse(localStorage.getItem("contacts") || "[]");
          contacts.splice(index, 1);
          localStorage.setItem("contacts", JSON.stringify(contacts));
          loadAdminData();
        }
      }

      // Fonction d'export PDF
      window.exportToPDF = function(type) {
        const reservations = JSON.parse(localStorage.getItem("reservations") || "[]");
        const contacts = JSON.parse(localStorage.getItem("contacts") || "[]");
        
        const doc = new jsPDF();
        
        // En-tÃªte du document
        doc.setFontSize(20);
        doc.setTextColor(52, 73, 94);
        doc.text('KM Ã‰ducateur Canin - Rapport', 20, 20);
        
        doc.setFontSize(12);
        doc.setTextColor(128, 128, 128);
        doc.text(`GÃ©nÃ©rÃ© le ${new Date().toLocaleDateString('fr-FR')}`, 20, 30);
        
        let yPosition = 50;
        
        if (type === 'reservations' || type === 'all') {
          // Section RÃ©servations
          doc.setFontSize(16);
          doc.setTextColor(241, 196, 15);
          doc.text('RÃ‰SERVATIONS', 20, yPosition);
          yPosition += 10;
          
          if (reservations.length > 0) {
            const reservationsData = reservations.map((res, index) => [
              index + 1,
              `${res.prenom} ${res.nom}`,
              res.telephone,
              res.email,
              res.chien,
              res.visio === 'oui' ? 'Oui' : 'Non',
              new Date(res.date).toLocaleDateString('fr-FR')
            ]);
            
            doc.autoTable({
              startY: yPosition,
              head: [['#', 'Nom', 'TÃ©lÃ©phone', 'Email', 'Chien', 'Visio', 'Date']],
              body: reservationsData,
              theme: 'grid',
              headStyles: {
                fillColor: [52, 73, 94],
                textColor: 255
              },
              alternateRowStyles: {
                fillColor: [245, 245, 245]
              }
            });
            
            yPosition = doc.lastAutoTable.finalY + 20;
          } else {
            doc.setFontSize(12);
            doc.setTextColor(128, 128, 128);
            doc.text('Aucune rÃ©servation', 20, yPosition);
            yPosition += 20;
          }
        }
        
        if (type === 'contacts' || type === 'all') {
          // Section Contacts
          doc.setFontSize(16);
          doc.setTextColor(241, 196, 15);
          doc.text('DEMANDES DE CONTACT', 20, yPosition);
          yPosition += 10;
          
          if (contacts.length > 0) {
            const contactsData = contacts.map((contact, index) => [
              index + 1,
              `${contact.prenom} ${contact.nom}`,
              contact.telephone,
              contact.email,
              contact.chien,
              getServiceName(contact.service),
              getUrgencyName(contact.urgence),
              contact.rappel === 'oui' ? 'Oui' : 'Non',
              new Date(contact.date).toLocaleDateString('fr-FR')
            ]);
            
            doc.autoTable({
              startY: yPosition,
              head: [['#', 'Nom', 'TÃ©lÃ©phone', 'Email', 'Chien', 'Service', 'Urgence', 'Rappel', 'Date']],
              body: contactsData,
              theme: 'grid',
              headStyles: {
                fillColor: [52, 73, 94],
                textColor: 255
              },
              alternateRowStyles: {
                fillColor: [245, 245, 245]
              }
            });
          } else {
            doc.setFontSize(12);
            doc.setTextColor(128, 128, 128);
            doc.text('Aucune demande de contact', 20, yPosition);
          }
        }
        
        // Statistiques
        doc.addPage();
        doc.setFontSize(16);
        doc.setTextColor(241, 196, 15);
        doc.text('STATISTIQUES', 20, 20);
        
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        const monthlyContacts = contacts.filter(contact => {
          const contactDate = new Date(contact.date);
          return contactDate.getMonth() === currentMonth && contactDate.getFullYear() === currentYear;
        }).length;
        
        const statsData = [
          ['Total RÃ©servations', reservations.length],
          ['Contacts ce mois', monthlyContacts],
          ['Demandes Visio', reservations.filter(r => r.visio === 'oui').length + contacts.filter(c => c.service === 'visio').length],
          ['Ã€ rappeler', reservations.filter(r => r.rappel === 'oui').length + contacts.filter(c => c.rappel === 'oui').length],
          ['DerniÃ¨re mise Ã  jour', new Date().toLocaleString('fr-FR')]
        ];
        
        doc.autoTable({
          startY: 40,
          body: statsData,
          theme: 'grid',
          headStyles: {
            fillColor: [52, 73, 94],
            textColor: 255
          },
          alternateRowStyles: {
            fillColor: [245, 245, 245]
          }
        });
        
        // Sauvegarder le PDF
        const fileName = `km_educateur_canin_${type}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
      }

      window.logout = function() {
        localStorage.removeItem('adminLoggedIn');
        adminLogin.style.display = 'block';
        adminPanel.style.display = 'none';
        document.getElementById('adminPassword').value = '';
      };

      // RafraÃ®chir les donnÃ©es toutes les 30 secondes
      setInterval(() => {
        if (localStorage.getItem('adminLoggedIn') === 'true') {
          loadAdminData();
        }
      }, 30000);
    });
  </script>
</body>
</html>